/**
 * 貸後智庫 - 數據管理模組
 * 管理知識庫、題庫、用戶進度等數據
 */

const DataManager = {
    // 存儲鍵名
    KEYS: {
        PROGRESS: 'loanmaster_progress',
        CHECKLIST: 'loanmaster_checklist',
        HISTORY: 'loanmaster_history',
        SETTINGS: 'loanmaster_settings'
    },

    // 初始化用戶進度
    initProgress() {
        const existing = this.getProgress();
        if (!existing) {
            const initial = {
                answered: 0,
                correct: 0,
                totalTime: 0,
                lastActive: Date.now(),
                domainStats: {},
                wrongQuestions: [],
                reviewSchedule: [],
                viewedKnowledge: []
            };
            this.saveProgress(initial);
            return initial;
        }
        return existing;
    },

    // 獲取進度
    getProgress() {
        try {
            const data = localStorage.getItem(this.KEYS.PROGRESS);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            console.error('讀取進度失敗:', e);
            return null;
        }
    },

    // 保存進度
    saveProgress(progress) {
        try {
            progress.lastActive = Date.now();
            localStorage.setItem(this.KEYS.PROGRESS, JSON.stringify(progress));
        } catch (e) {
            console.error('保存進度失敗:', e);
        }
    },

    // 更新答題統計
    updateAnswerStats(isCorrect, domain, questionId) {
        const progress = this.getProgress() || this.initProgress();
        progress.answered++;
        if (isCorrect) {
            progress.correct++;
        } else {
            // 記錄錯題
            if (!progress.wrongQuestions.includes(questionId)) {
                progress.wrongQuestions.push(questionId);
            }
        }

        // 更新領域統計
        if (!progress.domainStats[domain]) {
            progress.domainStats[domain] = { answered: 0, correct: 0 };
        }
        progress.domainStats[domain].answered++;
        if (isCorrect) {
            progress.domainStats[domain].correct++;
        }

        // 更新間隔複習計劃
        this.updateReviewSchedule(questionId, isCorrect, progress);

        this.saveProgress(progress);
        return progress;
    },

    // 更新間隔複習計劃（基於SM-2算法簡化版）
    updateReviewSchedule(questionId, isCorrect, progress) {
        const now = Date.now();
        const existing = progress.reviewSchedule.find(r => r.id === questionId);

        if (existing) {
            if (isCorrect) {
                existing.interval = Math.min(existing.interval * 2.5, 30); // 最長30天
                existing.easiness = Math.min(existing.easiness + 0.1, 2.5);
            } else {
                existing.interval = 1;
                existing.easiness = Math.max(existing.easiness - 0.3, 1.3);
            }
            existing.nextReview = now + existing.interval * 24 * 60 * 60 * 1000;
        } else {
            progress.reviewSchedule.push({
                id: questionId,
                interval: isCorrect ? 1 : 0.5,
                easiness: 2.0,
                nextReview: now + (isCorrect ? 1 : 0.5) * 24 * 60 * 60 * 1000
            });
        }
    },

    // 獲取需要複習的題目
    getReviewQuestions() {
        const progress = this.getProgress();
        if (!progress) return [];

        const now = Date.now();
        return progress.reviewSchedule
            .filter(r => r.nextReview <= now)
            .map(r => r.id);
    },

    // 記錄知識點閱讀
    markKnowledgeViewed(knowledgeId) {
        const progress = this.getProgress() || this.initProgress();
        if (!progress.viewedKnowledge.includes(knowledgeId)) {
            progress.viewedKnowledge.push(knowledgeId);
        }
        this.saveProgress(progress);
    },

    // 獲取檢查清單狀態
    getChecklistState(checklistId) {
        try {
            const data = localStorage.getItem(this.KEYS.CHECKLIST);
            const all = data ? JSON.parse(data) : {};
            return all[checklistId] || {};
        } catch (e) {
            console.error('讀取清單狀態失敗:', e);
            return {};
        }
    },

    // 保存檢查清單狀態
    saveChecklistState(checklistId, state) {
        try {
            const data = localStorage.getItem(this.KEYS.CHECKLIST);
            const all = data ? JSON.parse(data) : {};
            all[checklistId] = state;
            localStorage.setItem(this.KEYS.CHECKLIST, JSON.stringify(all));
        } catch (e) {
            console.error('保存清單狀態失敗:', e);
        }
    },

    // 獲取學習歷程
    getHistory(limit = 10) {
        try {
            const data = localStorage.getItem(this.KEYS.HISTORY);
            const history = data ? JSON.parse(data) : [];
            return history.slice(0, limit);
        } catch (e) {
            console.error('讀取歷程失敗:', e);
            return [];
        }
    },

    // 添加歷程記錄
    addHistory(action, detail, result = null) {
        try {
            const data = localStorage.getItem(this.KEYS.HISTORY);
            const history = data ? JSON.parse(data) : [];
            history.unshift({
                action,
                detail,
                result,
                time: Date.now()
            });
            // 只保留最近100條
            if (history.length > 100) {
                history.pop();
            }
            localStorage.setItem(this.KEYS.HISTORY, JSON.stringify(history));
        } catch (e) {
            console.error('保存歷程失敗:', e);
        }
    },

    // 計算能力評估數據
    getAbilityStats() {
        const progress = this.getProgress();
        if (!progress) {
            return {
                overall: 0,
                domains: {}
            };
        }

        const overall = progress.answered > 0
            ? Math.round((progress.correct / progress.answered) * 100)
            : 0;

        const domains = {};
        for (const [domain, stats] of Object.entries(progress.domainStats)) {
            domains[domain] = stats.answered > 0
                ? Math.round((stats.correct / stats.answered) * 100)
                : 0;
        }

        return { overall, domains };
    },

    // 獲取弱項列表
    getWeaknesses() {
        const { domains } = this.getAbilityStats();
        const weaknesses = [];

        for (const [domain, rate] of Object.entries(domains)) {
            if (rate < 70) { // 正確率低於70%視為弱項
                weaknesses.push({ domain, rate });
            }
        }

        return weaknesses.sort((a, b) => a.rate - b.rate);
    }
};

// ============================================
// 知識庫數據
// ============================================

const KnowledgeData = {
    domains: [
        {
            id: 'basics',
            name: '貸後管理基礎',
            icon: '📋',
            description: '貸後管理的定義、角色、監管要求及風險等級劃分',
            items: [
                {
                    id: 'basics-1',
                    title: '貸後管理的定義與目標',
                    importance: 4,
                    content: '貸後管理是指銀行在貸款發放後，對借款人的資信狀況、抵押物狀況、貸款資金使用情況等進行持續監控和管理的過程。其核心目標是減少銀行潛在損失的風險，確保貸款本息安全回收。',
                    tips: '記住：貸後管理不是「發放後就完事」，而是「風險管理的開始」。貸款發放只是信貸周期的中點，後半程的貸後管理決定了這筆貸款的最終結果。'
                },
                {
                    id: 'basics-2',
                    title: '三道防線職責劃分',
                    importance: 4,
                    content: '第一道防線：客戶經理/業務部門，負責日常貸後跟蹤、實地走訪、早期預警信號識別。\n第二道防線：風險管理部門，負責風險政策制定、貸後檢查督導、風險評估複核。\n第三道防線：內部審計部門，負責貸後管理制度執行情況審計、問題整改跟蹤。',
                    tips: '作為貸後人員，你主要在第一道防線工作。記住：你是離客戶最近的人，也是發現問題的第一人。'
                },
                {
                    id: 'basics-3',
                    title: '監管法規要求（HKMA）',
                    importance: 4,
                    content: '香港金融管理局對貸後管理有明確要求：\n1. 定期覆核借款人財務狀況\n2. 抵押品定期重估\n3. 貸款分類及減值評估\n4. 重組/展期貸款的特別監控\n5. 問題貸款的及時報告',
                    tips: '監管要求是底線，不是目標。優秀的貸後管理應該走在監管前面，主動發現和防範風險。'
                },
                {
                    id: 'basics-4',
                    title: '風險分類標準',
                    importance: 4,
                    content: '五級分類法：\n• 正常：借款人能夠履行合同，沒有足夠理由懷疑本息不能按時足額償還\n• 關注：借款人目前有能力償還，但存在可能對償還產生不利影響的因素\n• 次級：借款人的還款能力出現明顯問題，依靠正常營收無法足額償還\n• 可疑：借款人無法足額償還本息，即使執行抵押亦會造成較大損失\n• 損失：採取所有可能措施後，本息仍無法收回',
                    tips: '分類要及時、準確。寧可「升級」（提高風險等級）時保守一些，也不要等問題爆發才調整。'
                },
                {
                    id: 'basics-5',
                    title: '貸後管理頻率要求',
                    importance: 3,
                    content: '根據風險等級，設定不同的貸後管理頻率：\n• 正常類：至少每年一次全面檢查\n• 關注類：至少每半年一次\n• 次級類：至少每季度一次\n• 可疑/損失類：至少每月一次\n抵押物檢查頻率可根據押品類型和市場波動情況調整。',
                    tips: '這是最低要求。對於金額大、行業敏感的客戶，應提高檢查頻率。'
                },
                {
                    id: 'basics-6',
                    title: '四部門職責分工體系',
                    importance: 4,
                    content: '公司授信貸後管理四部門分工：\n\n1. 授信單位（第一道防線）：\n• 對真實性、完整性及時發現和報告風險\n• 承擔管理責任，對關鍵按信用評級、對儲信定期檢查\n• 提出合適建議或控制措施\n\n2. 授信管理部（第二道防線）：\n• 系統功能開發和完善、制度完善工具和流程\n• 實施風險監控、分析、評估、排查及檢查授信單位\n• 建立和完善客戶管理體系，審核名單\n\n3. 風險管理部：\n• 按《信貸評級工作辦法》對投信單位所報交的人工評級申請作最終覆定\n• 按相關辦法進行管理及跟進\n\n4. 稽核部（第三道防線）：\n• 履行風險管理第三道防線，獨立角色作評估及建議\n• 預防及減低銀行面對的風險',
                    tips: '四部門各司其職、相互制衡。授信單位是最前線，要主動發現問題；授信管理部是監督者；稽核部是最後一道把關。'
                },
                {
                    id: 'basics-7',
                    title: '臨期管理規範',
                    importance: 4,
                    content: '臨期管理適用於：\n1. 企業條線公司授信戶\n2. 零售條線公司授信戶且餘額超過5,000萬的還款\n\n關鍵時間節點：\n• 業務到期前1個月：了解客戶是否有足額資金還款\n• 及時提醒客戶存入足額資金還款\n• 如發現扣款未成功：應及時查明原因（客戶資金週轉問題/系統扣款問題）\n• 如為系統扣款問題：應及時聯繫相關部門解決\n• 防止臨時性、技術性逾期的發生\n\n貸款如發生逾期：\n• 授信單位應按第7章風險監測啟動 EARLY ALERT SYSTEM 流程\n• 按條線通知公司部/零管部及零貸部/市場部\n• 協商解決方案，盡最大可能避免逾期天數',
                    tips: '臨期管理的核心是「提前」——提前1個月就要開始跟進，不要等到到期日才發現問題。'
                },
                {
                    id: 'basics-8',
                    title: 'EAS 早期預警系統',
                    importance: 4,
                    content: 'EAS（Early Alert System）表格欄位設計：\n\n基本信息欄位：\n• 授信單位編號、授信單位名稱\n• 上市公司/集團公司、上市/集團編號\n• 業務性質、信息種類、借戶名稱、客戶號\n\n監控欄位：\n• EAS接收相關訊息日期、發出EAS日期\n• 回覆期限（一個工作天）\n• 1st Reminder、2nd Reminder、3rd Reminder\n• 前線回覆日期、未能在指定時間內回覆\n\n風險評估欄位：\n• 備註、風險成因、對我行影響\n• 單位已採取措施、解決方案及其他建議\n• 評分、貸後管理組、授位策略建議、貸後管理組意見\n• 經辦人、覆核人',
                    tips: 'EAS 系統是風險預警的核心工具。收到 EAS 通知後必須在一個工作天內回覆，連續未回覆會觸發 Reminder 升級。'
                },
                {
                    id: 'basics-9',
                    title: '查訪頻率及要求',
                    importance: 4,
                    content: '查訪是授信單位對授信客戶（不含債券業務）作不定期監控的一種方式：\n\n查訪頻率：\n• 授信單位應每三個月或按審批批示要求頻次進行查訪\n• 按公司部/零管部所訂格式要求填寫查訪報告\n• 並妥善存檔備查\n\n減退加固客戶：\n• 按《交通銀行公司客戶減退加固管理辦法》執行\n• 減退加固客戶隨訪紀錄固定頻率調整至不低於兩個月（含）一次\n• 隨訪紀錄應充分反映客戶風險變化及「一戶一策」執行情況\n\n負面情況處理：\n• 如於查訪時發現客戶出現負面情況\n• 應按第7章風險監控及第9章風名單管理體系作後續跟進',
                    tips: '查訪不是走過場！要認真填寫報告，發現任何負面情況必須立即按流程上報。'
                },
                {
                    id: 'basics-10',
                    title: '風險名單管理體系',
                    importance: 4,
                    content: '風險名單分類及管理：\n\n1. 減退加固名單：\n• 針對存在重大風險的客戶\n• 需制定「一戶一策」處置方案\n• 隨訪頻率不低於每兩個月一次\n\n2. 觀察名單：\n• 出現潛在風險授信客戶納入\n• 進行減退加固名單或觀察名單的提示\n• 並提出「一戶一策」建議\n\n3. 重點關注名單：\n• 新增申請審批表\n• 調入申請表\n• 一戶一策調整申請表\n\n相關附件表格：\n• 附件2：EAS名單更新表\n• 附件3：EAS系統監控名單\n• 附件4：減退加固名單標準\n• 附件5：重點關注名單客戶新增申請審批表\n• 附件10：納入/剔出風險名單通知書\n• 附件12：重點客戶跟蹤排查表',
                    tips: '名單管理是動態的！客戶風險變化時要及時調整名單類別，不要等到出問題才補救。'
                },
                {
                    id: 'basics-11',
                    title: '提示名單納入 10 項標準',
                    importance: 4,
                    content: '如出現以下潛在風險特徵，評估影響企業償債但尚未喪失償還能力，應納入減退加固提示名單觀察：\n\n（一）連續2個會計年度淨利潤為負\n（二）經營性及投資性淨現金流連續2年為負，同時利息償付率（EBITDA/淨利息支出）小於1（非建設期項專案公司適用）\n（三）在本行或他行因財務困難實施逾1次（含）以上重組；或在本行業務逾欠（含墊款）逾7天（不含）\n（四）客戶 PD 評級同比下調3級且下調後評級不優於7級（含）；客戶發債主體最新國際評級被授信申報時下調2級且評級展望負面\n（五）折騰集團列入交行信用風險關注體系管理策略紅色或橙色類，同時板塊策略為減退；或當地中資同業採取明減措施\n（六）被認定為洗錢高風險等級客戶或制裁風險「禁止類名單」\n（七）客戶債券發行價異常、或已發行債券價格異常下跌\n（八）客戶被境外監管機構採取負面管控措施；客戶涉及被列入交行國際化戰略行業（區域）政策及投向引導清單所列事項，或觸發授信審批減持等條件\n（九）因訴訟/履約/惡意欺詐等事宜，客戶信譽/形象受損導致勞動力或遭收購威脅，資力較弱，抗風險能力較脆弱\n（十）其他等認為有必要納入提示名單管理情形',
                    tips: '10 項標準是硬指標！任何一項觸發都必須啟動名單納入流程。'
                },
                {
                    id: 'basics-12',
                    title: '減退加固管理流程',
                    importance: 4,
                    content: '減退加固管理的定義與流程：\n\n定義：減退加固客戶是指非不良客戶中，已出現影響償債的潛在風險，但尚未喪失授信業務本息償還能力，需調整其管控策略為減退加固並納入減退加固管理的公司信貸及非信貸業務授信戶，適用範圍為所有公司授信戶\n\n納入條件：\n• 符合減退加固特徵的客戶，應納入減退加固名單管理\n• 減退加固名單下設(1)重點關注名單和(2)提示名單，根據風險情況分層分類管理\n• 名單不交叉、不重疊\n• 減退加固名單進入標準應按照折騰行《信貸評級工作辦法》的規定執行\n\n管理原則：\n• 減退加固-重點關注客戶為減退加固客戶中具有較大潛在風險客戶，原則上五級分類應為關注類\n• 減退加固名單為交銀集團內部管理使用，任何人不得向客戶透露',
                    tips: '減退加固不是貶義詞，是主動管理風險的手段。重點在「加固」而非「減退」。'
                },
                {
                    id: 'basics-13',
                    title: '貸後管理例會制度',
                    importance: 4,
                    content: '貸（投）後管理例會主要負責審議或聽取與貸（投）後管理工作相關的重要議題或重大事項報告，並就重點工作進行決策部署：\n\n例會成員包括：\n• 分管授信風險和分管公司業務的行領導\n• 授信管理部門（牽頭召集負責）\n\n會議頻率：原則上每季召開，另已按月加開月度會議\n\n議事範圍主要包括：\n（一）確定階段性貸（投）後管理重點或風險排查重點\n（二）研究確定重點、疑難、有分歧客戶的減退加固名單調整和「一戶一策」\n（三）總結減退加固名單管理執責及名單客戶「一戶一策」執行情況\n（四）定期檢視本行貸（投）後管理制度執行情況\n（五）定期檢視本行貸（投）後管理、減退加固管理等制度\n（六）其他需討論的貸（投）後管理事項',
                    tips: '例會不是形式主義！每次例會都要有明確的議題和決議，確保跟進落實。'
                },
                {
                    id: 'basics-14',
                    title: '不良案例分享：LED 生產、地產租賃',
                    importance: 4,
                    content: '案例一：客戶 K（主營 LED 照明產品研發及生產業務）\n• 曾於2023年9月底出現逾期，10月償還逾期欠款，港行以續貸「四早」原則，前中後台共同制定清退策略\n• 經研判將客戶以「壓擔保」獲取物業的二按，取得優於同業的風險緩解異地，各級客戶於2024年1月因資金緊張而向港行申請貸款展期，我行在此期間進一步要求加擔\n• 改善安全邊際，如購入「子公司乙」及「子公司丙」的實際報價後，需快加固需客戶前線單位加急處理上述內容\n• 處置策略：嘗試推動「子公司乙」及「子公司丙」償還，其中後者有其内部及外部融資擔保作為一有限保供的額度\n• 成功先行收回 7,988 萬港元\n\n案例二：客戶 L（經營房地產租賃）\n• 主要持有重建商業作收租之用，2023年3月因大租戶退租而納入港行觀察名單\n• 期後於2024年7月辦理授信定期檢查時，發現作用物業的租金收入不足以支付利息費用，而該基金亦於額外召開的貸（投）後管理月庭會議中折判議通過退出方案\n• 以減低港行風險，在向客戶逼離壓下，最終借內大股東某國家主權退休基金通知購入該商業物業項目降至48%股權\n• 買賣持有該商業作用物業後，上交易最終於2024年年底前完成，我行提前全數收回4億港元欠款',
                    tips: '真實案例說明：及早識別問題、堅持「四早」原則、多部門協同，才能成功處置風險資產。'
                },
                {
                    id: 'basics-15',
                    title: '中國特色金融文化',
                    importance: 3,
                    content: '交通銀行（香港）強調的中國特色金融文化：\n\n• 誠實守信：不逾越底線\n• 以義取利：不唯利是圖\n• 穩健審慎：不急功近利\n• 守正創新：不脫實向虛\n• 依法合規：不胡作非為',
                    tips: '這是文化底線，不僅適用於業務操作，更適用於貸後管理的每一個判斷。'
                }
            ]
        },
        {
            id: 'fieldVisit',
            name: '實地走訪技術',
            icon: '🚶',
            description: '走訪前準備、現場核查、訪談技巧及證據留存規範',
            items: [
                {
                    id: 'visit-1',
                    title: '走訪前準備清單',
                    importance: 4,
                    content: '必須完成的準備工作：\n1. 取得客戶最新工商登記資料副本\n2. 列印客戶申貸時的營業地址、廠房地址清單\n3. 準備客戶最近三期財務報表對比表\n4. 攜帶能拍攝帶時間戳照片的設備\n5. 與客戶預約並確認關鍵管理層在場\n6. 準備上次走訪報告以便對比變化',
                    tips: '「不打無準備之仗」——走訪前的準備工作決定了走訪的效果。確保法人或財務負責人能出席，否則走訪價值大打折扣。'
                },
                {
                    id: 'visit-2',
                    title: '辦公環境真實性核查',
                    importance: 4,
                    content: '必查項目（4級重要性）：\n• 辦公室地址與工商登記是否一致\n• 公司名稱標識是否清晰可見\n• 辦公面積是否與申報規模相符\n\n重要項目（3級）：\n• 現場員工人數與申報是否匹配\n• 員工是否在正常工作狀態\n• 辦公設備是否正常運作\n• 是否有財務室或財務辦公區域',
                    tips: '細節決定真假：觀察員工桌面是否有工作痕跡、電腦是否開機工作、是否有業務電話響起。空殼公司往往「太乾淨」。'
                },
                {
                    id: 'visit-3',
                    title: '管理層訪談技巧',
                    importance: 4,
                    content: '必問問題（4級重要性）：\n• 法定代表人是否在場？如否，原因是什麼？\n• 主營業務和主要產品是什麼？（測試熟悉程度）\n• 員工工資發放情況，上次發薪日是何時？\n• 貸款資金具體使用項目是什麼？\n• 其他銀行授信情況\n• 是否有重大訴訟或處罰\n\n訪談時注意觀察對方的神態和反應速度。',
                    tips: '好的訪談是「聊天」不是「審問」。從輕鬆話題開始，逐步深入關鍵問題。注意：法人總是「出差」是重大警示信號。'
                },
                {
                    id: 'visit-4',
                    title: '財務文件現場核查',
                    importance: 4,
                    content: '必查項目：\n• 最近三個月銀行對賬單原件（主要收款賬戶流水）\n• 異常大額資金進出記錄\n• 應收賬款明細表（重點關注賬齡超90天比例）\n• 財務賬簿記錄與申報報表數據一致性\n• 稅務申報是否正常（有無欠稅或處罰）\n• 納稅申報與財務報表一致性',
                    tips: '看原件，不要只看複印件。對賬單上的異常大額交易要追問來龍去脈。收入高但現金進不來，虛假可能性大。'
                },
                {
                    id: 'visit-5',
                    title: '廠房生產核查要點',
                    importance: 4,
                    content: '核心檢查項目：\n• 廠房地址與產權證明一致性\n• 廠房佔地及建築面積與申報對比\n• 生產線數量及開工率\n• 生產設備運轉狀況\n• 原材料庫存量（可支持多少天生產）\n• 產成品庫存與明細表是否相符',
                    tips: '聽聲音、看痕跡。生產線開動時有聲音、有熱量、有粉塵。設備上的銹跡和油污痕跡能判斷使用頻率。'
                },
                {
                    id: 'visit-6',
                    title: '抵押物現場核實',
                    importance: 4,
                    content: '必查項目：\n• 抵押資產現場狀況（損毀或貶值跡象）\n• 資產是否被其他機構查封\n• 主要設備產權爭議（融資租賃或所有權保留）\n• 是否存在重複抵押\n\n建議項目：\n• 抵押物標識張貼（本行抵押標識）\n• 固定資產與明細表一致性',
                    tips: '抵押物是最後的保障。確保：存在、可變現、未被佔用。發現查封文書立即上報！'
                },
                {
                    id: 'visit-7',
                    title: '證據留存規範',
                    importance: 4,
                    content: '必須拍攝/收集：\n• 公司門牌及辦公環境照片（帶時間戳全景照片）\n• 生產車間及設備照片（多角度拍攝）\n• 抵押物現狀照片（多角度詳細拍攝）\n• 相關證照照片（營業執照、產權證等）\n• 訪談記錄簽字確認\n• 檢查表簽字蓋章\n• 問題記錄及客戶說明',
                    tips: '照片要帶時間戳、要有參照物、要多角度。訪談記錄讓客戶簽字確認，這是未來可能的證據。'
                },
                {
                    id: 'visit-8',
                    title: '風險預警信號識別',
                    importance: 4,
                    content: '高風險預警信號（必須立即上報）：\n• 客戶多次推遲或拒絕走訪\n• 現場發現法院查封、扣押文書\n• 其他金融機構人員在場追債\n• 設備搬離或資產轉移跡象\n\n中度預警信號：\n• 經營規模明顯萎縮\n• 管理層精神狀態異常（焦慮或迴避）\n• 員工私下反映工資拖欠\n• 水電表讀數長期很低',
                    tips: '發現一個高風險信號就足以啟動預警程序。不要等湊齊多個信號才行動，時間就是金錢。'
                }
            ]
        },
        {
            id: 'financial',
            name: '財務報表分析',
            icon: '📊',
            description: '財務報表審閱技術、異常指標識別及造假紅旗信號',
            items: [
                {
                    id: 'fin-1',
                    title: '應收帳款分析技術',
                    importance: 4,
                    content: '紅旗指標：\n• 營收增長20%，但應收帳款同期增長50%以上\n• 應收帳款周轉率同比下降>20%\n• 賬齡超90天應收款佔比異常高\n\n分析方法：\n1. 計算應收帳款周轉天數趨勢\n2. 分析前五大應收款客戶集中度\n3. 核對應收款明細與銷售記錄一致性',
                    tips: '應收帳款是財務造假的重災區。收入高但錢收不回來，要麼客戶有問題，要麼收入是假的。'
                },
                {
                    id: 'fin-2',
                    title: '存貨與毛利率異常識別',
                    importance: 4,
                    content: '危險信號：\n• 存貨周轉率與應收帳款周轉率同時異常下降，但營收大幅上升\n• 毛利率異常穩定（如多年維持固定回報率），違背市場波動常理\n• 存貨佔營收比例>30%且周轉率<2次/年\n\n這類特徵往往是「融資性貿易」或財務造假的表現。',
                    tips: '毛利率「太穩定」反而可疑。真實業務會隨原材料價格、訂單結構變化而波動。'
                },
                {
                    id: 'fin-3',
                    title: '現金流與利潤背離判斷',
                    importance: 4,
                    content: '核心判斷標準：\n• 經營活動現金流量淨額<淨利潤的50%：高度可疑\n• 連續多期經營現金流為負但利潤持續增長：極度危險\n• 損益表顯示大量營收和利潤，但現金流遠低於利潤\n\n這意味著：收入可能虛掛在應收帳款或存貨中。',
                    tips: '「利潤是意見，現金是事實」。不管報表多漂亮，錢進不來就是最大的問題。'
                },
                {
                    id: 'fin-4',
                    title: '預付/預收款異常分析',
                    importance: 3,
                    content: '預警信號：\n• 預付帳款佔總資產>15%：異常偏高\n• 預付帳款比例突然激增：可能為上下游提供融資\n• 現金周轉周期特別短（如<10天）但聲稱有實體生產：不符合常理\n\n分析時需詢問：\n• 預付款具體對象和業務用途\n• 為何需要大額預付？對方是否有特殊折扣？',
                    tips: '大額預付款往往是資金轉移的通道。問清楚為什麼要預付、對方是誰、有沒有關聯關係。'
                },
                {
                    id: 'fin-5',
                    title: '財務造假紅旗指標速查',
                    importance: 4,
                    content: '必查指標對照表：\n| 指標 | 正常範圍 | 紅旗線 |\n|------|---------|-------|\n| 應收帳款增速 | ≤營收增速 | >營收增速1.5倍 |\n| 經營現金流/淨利潤 | >70% | <50% |\n| 毛利率波動 | ±5% | 多年恆定 |\n| 存貨周轉率 | >2次/年 | <1次/年 |\n| 預付款佔比 | <10% | >15% |',
                    tips: '單一指標異常可能有解釋，多個指標同時異常就要高度警惕。'
                },
                {
                    id: 'fin-6',
                    title: '財報審查四線並行法',
                    importance: 4,
                    content: '貿融業務真實性審查需要「四條線並行」：\n\n1. 帳務線：應收帳款失速增長、毛利率異常穩定、現金流與利潤背離、預付款異常波動\n\n2. 合同線：紅旗條款識別（固定收益率、不對貨物負責）、前五大客戶/供應商穿透、同日簽訂合同識別\n\n3. 物流線：原始倉儲單抽查、運輸GPS記錄、驗收簽收單；費用匹配度（運輸費、倉儲費與營收規模匹配）\n\n4. 資金線：銀行流水交叉驗證、資金停留時間分析、發票與報關數據核對\n\n結論：單靠財報數字和完整單據無法判定貿易真實性，必須採用立體審查方法。',
                    tips: '四線並行不是按順序做，而是同時進行、交叉驗證。任何一條線亮紅燈都要深究。'
                },
                {
                    id: 'fin-7',
                    title: '虛假貿易識別指標速查表',
                    importance: 4,
                    content: '| 識別維度 | 虛假貿易特徵 | 審查方法 |\n| :-- | :-- | :-- |\n| 毛利率 | 固定／異常穩定 | 與同行業可比企業對比，波動>5%視為正常 |\n| 應收帳款 | 增速遠超營收增速 | 計算應收帳款周轉率，同比下降>20%危險 |\n| 預付款 | 占總資產>15% | 詢問預付款具體對象和業務用途 |\n| 存貨 | 占營收比例>30%且周轉率<2次/年 | 驗證存貨的真實性和變現能力 |\n| 現金流 | 經營淨現金流<淨利潤的50% | 收入高但現金進不來，虛假可能性大 |\n| 交易結構 | 同一實控人下多家企業環型交易 | 追蹤股權關係，識別隱藏的關聯方 |\n| 交易對手 | 經銷商／代理商而非終端用戶 | 前五大客戶穿透，確認最終購買方 |\n| 資金流向 | 款進帳戶<3天即轉出 | 銀行流水Backward tracing |\n| 費用水平 | 運輸費、倉儲費不符合貿易規模 | 與同行業對標，差異>50%可疑 |\n| 報關數據 | 出口報關與國內銷售發票數量不符 | 調取海關數據交叉驗證 |',
                    tips: '這10個維度就是你的「貸後審查」核對清單，逐項核對即可快速識別問題。'
                },
                {
                    id: 'fin-8',
                    title: '財報與稅務/報關數據交叉驗證',
                    importance: 4,
                    content: '財報數據交叉驗證技術：\n\n1. 發票與報關核對：增值稅發票金額、品名、數量與海關報關數據是否相符\n\n2. 出口退稅驗證：出口退稅記錄與聲稱的出口貿易規模是否匹配\n\n3. 稅務申報對比：向稅務局調取增值稅申報記錄，與公司提供的發票金額交叉比對\n\n4. 銀行流水追蹤：追溯資金最終去向，看是否流向獨立第三方還是在關聯方內部兜圈\n\n核查要點：\n• 不要提前通知被查公司再進行第三方核實\n• 計算「資金停留時間」：收款後<3天即全額轉出屬於典型空轉特徵',
                    tips: '打電話給倉儲公司、物流公司核實時，不要提前通知被查公司。突擊核實效果最好。'
                }
            ]
        },
        {
            id: 'tradeFin',
            name: '貿易融資真實性審查',
            icon: '🔍',
            description: '購銷合同審查、貨物流轉核實、資金流向穿透及商業邏輯判斷',
            items: [
                {
                    id: 'trade-1',
                    title: '融資性貿易識別要點',
                    importance: 4,
                    content: '融資性貿易的典型特徵：\n1. 收益模式：合同約定固定收益率（如年化12%）而非隨市場波動\n2. 資金投入：只有一方投入資金，其他方無實際新投入\n3. 貨物控制：合同明確某方「不對貨物質量/數量負責」\n4. 交易結構：形成封閉循環（甲→乙→丙→甲）\n5. 單據齊全≠交易真實：齊全的合同、發票可能只是「表演道具」',
                    tips: '融資性貿易的本質是「以貿易之名行融資之實」。單據再齊全，只要沒有真實貨物流轉，就是虛假貿易。'
                },
                {
                    id: 'trade-2',
                    title: '購銷合同審查要點',
                    importance: 4,
                    content: '紅旗條款：\n• 合同約定固定收益率、回報率、資金佔用費等非貿易用語\n• 條款明確某方「不對貨物質量/數量負責」\n• 大量補充協議、抽屜協議與主合同實質衝突\n\n交易對手穿透：\n• 主要交易對手是經銷商而非終端使用企業\n• 供應商與客戶名單出現相同或相似企業（封閉循環）',
                    tips: '看「字眼」：真實買賣用「貨款」「交貨」，融資性質用「欠款」「借款」「投資回報」。'
                },
                {
                    id: 'trade-3',
                    title: '貨物流轉核實技術',
                    importance: 4,
                    content: '實物控制檢查：\n• 抽查原始倉儲單、運輸GPS記錄、驗收簽收單\n• 向倉儲公司、物流公司獨立核實\n\n費用匹配度分析：\n• 銷售費用規模與貿易規模是否匹配\n• 運輸費、倉儲費是否與聲稱的貨物流轉相符\n• 如大量貨物流轉但運輸費異常低或為零：極度可疑',
                    tips: '打電話給倉儲公司、物流公司核實時，不要提前通知被查公司。突擊核實效果最好。'
                },
                {
                    id: 'trade-4',
                    title: '資金流向穿透分析',
                    importance: 4,
                    content: '銀行流水交叉驗證：\n• 追溯資金最終去向：流向獨立第三方還是在關聯方內部兜圈\n• 資金停留時間：收款後<3天即全額轉出，且轉入方是上游供應商=典型空轉\n\n發票與報關數據核對：\n• 增值稅發票金額、品名、數量與海關報關數據是否相符\n• 出口退稅記錄與聲稱的出口規模是否匹配',
                    tips: '畫出資金流向圖，真實貿易是「線性」流動（A→B→C→終端），虛假貿易是「環形」流動（A→B→C→A）。'
                },
                {
                    id: 'trade-5',
                    title: '商業邏輯合理性判斷',
                    importance: 4,
                    content: '定價機制檢查：\n• 長期大額往來，價格脫離市場價（如銅價波動±20%，合同價格不變）\n• 「高買低賣」：上游採購價>下游銷售價（靠「利息」補償）\n\n交易環節合理性：\n• 人為增加中間環節：A、C都能直接交易，卻讓B介入做「二道販子」\n• B無任何增值服務（不加工、不倉儲、不配送）',
                    tips: '問自己：這個中間商存在的價值是什麼？如果答不上來，就是專門為了「過橋」而設。'
                },
                {
                    id: 'trade-6',
                    title: '案例：通號vs永安融資性貿易',
                    importance: 3,
                    content: '案情：央企通號與永安公司簽訂煤炭買賣合同，單據齊全（合同、發票、貨權單、對賬函）。\n\n法院認定虛假的關鍵證據：\n1. 框架協議寫明「資金循環制使用」「籌集資金5000萬用於合作」\n2. 補充協議約定「年投資回報率不低於12%」\n3. 往來函件使用「欠款」「借款」而非「貨款」「交貨」\n4. 國資委認定為「以貿易為名，實為出借資金」',
                    tips: '這個案例說明：單據齊全不等於交易真實，要看合同條款的實質內容和商業邏輯。'
                },
                {
                    id: 'trade-7',
                    title: '貸後審查四步法完整流程',
                    importance: 4,
                    content: '貸後審查實操流程：\n\n第一步：快速篩查（1-2日）\n• 拉取疑似公司近三年應收帳款、存貨、預付款、營收、毛利率數據\n• 計算周轉率及增長率，標記異常值≥30%波動的項目\n• 調取前五大客戶／供應商清單，用企查查／天眼查識別關聯方\n\n第二步：合同文本審查（2-3日）\n• 抽查大額合同（如單筆≥500萬），重點看定價條款、收益約定、貨物責任條款\n• 標記「固定回報」「資金循環」等敏感表述\n• 核對上下游合同簽訂日期、標的、單價，看是否「同日簽訂、只差價格」\n\n第三步：第三方核實（3-5日）\n• 抽樣打電話給倉儲公司、物流公司、終端客戶核實\n• 向稅務局調取增值稅申報、出口退稅記錄交叉比對\n• 不要提前通知被查公司！\n\n第四步：銀行流水分析（2-3日）\n• 調取疑似公司及主要交易對手在你行的帳戶流水\n• 追蹤大額資金（如≥100萬）最終去向，畫出資金流向圖\n• 計算「資金停留時間」：收款後<3天即全額轉出屬空轉特徵',
                    tips: '貸後審查的核心是「不信任任何單一來源」，用多個獨立來源交叉驗證。'
                },
                {
                    id: 'trade-8',
                    title: '真實案例復盤：法院認定融資性貿易的關鍵證據',
                    importance: 4,
                    content: '通號vs永安案深度解析：\n\n| 財務指標 | 正常貿易特徵 | 本案異常表現 | 審查結論 |\n| :-- | :-- | :-- | :-- |\n| 收益模式 | 毛利率隨市場波動 | 合同明確約定年回報率12% | 固定收益=融資性質 |\n| 資金投入 | 各方按交易需要投入 | 只有通號初始6000萬在循環流轉 | 資金空轉 |\n| 貨物控制 | 買方驗收、倉儲、運輸記錄 | 合同明確「不對貨物負責」 | 無真實貨權轉移 |\n| 交易結構 | 線性供應鏈 | 四方封閉循環，資金反向流回 | 人為增加環節 |\n| 單據完整度 | 齊全 | 齊全 | 單據齊全≠交易真實 |\n\n法院認定關鍵證據：\n1. 合同條款自相矛盾——名為買賣，實約固定收益\n2. 往來函件反复提及「欠款」「借款」\n3. 後續「補救合同」明確寫「處理預付款債權」\n4. 國資委通報認定「以貿易為名，實為出借資金」',
                    tips: '這個判例的教訓：看合同的「實質」而非「形式」，當事人自己的用語往往暴露真實意圖。'
                }
            ]
        },
        {
            id: 'riskAssess',
            name: '客戶風險評估',
            icon: '⚠️',
            description: '風險分類標準、信用評級技術、關聯方識別及行業風險分析',
            items: [
                {
                    id: 'risk-1',
                    title: '風險等級動態調整原則',
                    importance: 4,
                    content: '升級（提高風險等級）觸發條件：\n• 逾期超過30天\n• 發現重大負面信息（訴訟、處罰等）\n• 主要經營指標大幅惡化\n• 抵押物價值明顯下降\n\n降級（降低風險等級）條件：\n• 連續6個月以上正常還款\n• 經營狀況明顯改善且有實質證據\n• 增加有效擔保',
                    tips: '升級要果斷，降級要謹慎。寧可「過度預警」，也不要「後知後覺」。'
                },
                {
                    id: 'risk-2',
                    title: '關聯方識別方法',
                    importance: 4,
                    content: '顯性關聯：\n• 股權關係（直接或間接控股）\n• 董監高交叉任職\n• 同一實控人\n\n隱性關聯（更危險）：\n• 同一辦公地址、電話、網站\n• 資金往來頻繁且無合理業務解釋\n• 互相擔保或串聯擔保\n• 使用相同財務人員或代理機構',
                    tips: '用企查查/天眼查穿透股權，追到自然人層面。隱性關聯往往比顯性關聯更危險。'
                },
                {
                    id: 'risk-3',
                    title: '行業風險快速判斷',
                    importance: 3,
                    content: '高風險行業特徵：\n• 產能過剩行業（鋼鐵、水泥、玻璃等）\n• 政策調控行業（房地產限購區域等）\n• 高度依賴政府補貼或單一大客戶\n• 技術快速迭代行業（可能突然被淘汰）\n\n行業分析維度：\n• 行業景氣度趨勢\n• 企業在行業中的地位\n• 上下游議價能力',
                    tips: '再好的企業，在沒落的行業裡也難以獨善其身。行業風險是系統性風險。'
                },
                {
                    id: 'risk-4',
                    title: '實控人背景調查',
                    importance: 4,
                    content: '必查項目：\n• 是否有訴訟執行記錄\n• 是否被列入失信被執行人\n• 名下其他企業經營狀況\n• 個人負債情況（房貸、消費貸等）\n• 婚姻家庭是否穩定（離婚可能涉及資產分割）\n\n資訊來源：\n• 中國執行信息公開網\n• 企業信用信息公示系統\n• 裁判文書網',
                    tips: '企業是實控人的延伸。實控人出問題，企業遲早出問題。'
                }
            ]
        },
        {
            id: 'fundTrack',
            name: '資金用途追蹤',
            icon: '💰',
            description: '放款流向監控、資金回流識別、違規用途處置',
            items: [
                {
                    id: 'fund-1',
                    title: '資金用途核實要點',
                    importance: 4,
                    content: '必查項目：\n• 貸款資金具體支出項目與合同約定用途對比\n• 資金支付憑證（轉賬記錄、發票、收據）\n• 設備採購資金：設備是否到場可查看\n• 原材料採購資金：庫存是否相應增加\n• 工程建設資金：工程進度及施工現場',
                    tips: '「看錢去了哪裡」是最直接的驗證。資金用途不符合合同約定，就是違約。'
                },
                {
                    id: 'fund-2',
                    title: '資金回流識別技術',
                    importance: 4,
                    content: '典型回流特徵：\n• 放款後資金快速（<3天）轉至關聯方\n• 轉出後資金通過多個賬戶繞回借款人或實控人\n• 轉出對象無法提供真實交易證明\n\n識別方法：\n• 繪製資金流向圖\n• Backward tracing：追溯資金最終去向\n• 比對轉出對象與借款人的關聯關係',
                    tips: '資金回流=套取銀行資金。一旦發現，立即上報並考慮提前收貸。'
                },
                {
                    id: 'fund-3',
                    title: '挪用資金風險判斷',
                    importance: 4,
                    content: '常見挪用情形：\n• 用於非經營性支出（購買理財、投資股市等）\n• 用於關聯方資金調撥\n• 用於償還其他債務\n• 用於禁止性用途（房地產、股票等限制領域）\n\n判斷依據：\n• 資金流向與經營活動不匹配\n• 無法提供與用途對應的票據憑證',
                    tips: '挪用資金往往是借款人資金鏈緊張的信號。發現挪用要追問：為什麼需要挪用？錢去了哪裡？'
                },
                {
                    id: 'fund-4',
                    title: '違規用途處置流程',
                    importance: 4,
                    content: '處置步驟：\n1. 立即書面記錄違規事實及證據\n2. 向風險管理部門報告\n3. 要求借款人書面說明\n4. 評估是否構成貸款合同違約\n5. 根據嚴重程度決定：警告、要求糾正、提前收貸\n\n注意事項：\n• 保留所有溝通記錄\n• 不要輕易接受口頭承諾\n• 設定整改期限並跟進',
                    tips: '處置要有書面記錄、有時限要求、有跟進機制。口頭處理等於沒處理。'
                }
            ]
        },
        {
            id: 'problemLoan',
            name: '貸後問題處置',
            icon: '🔧',
            description: '預警信號響應、風險緩釋措施、不良資產處置及案例復盤',
            items: [
                {
                    id: 'prob-1',
                    title: '預警信號響應機制',
                    importance: 4,
                    content: '三級響應機制：\n\n紅色預警（24小時內響應）：\n• 發現法院查封、凍結\n• 實控人失聯或跑路\n• 重大負面輿情\n\n橙色預警（72小時內響應）：\n• 逾期超過30天\n• 抵押物價值大幅下跌\n• 發現資金挪用\n\n黃色預警（7日內響應）：\n• 經營指標惡化\n• 關聯企業出現問題\n• 行業出現系統性風險',
                    tips: '預警不是目的，響應才是。收到預警信號後的第一件事：打電話給客戶確認情況。'
                },
                {
                    id: 'prob-2',
                    title: '風險緩釋措施',
                    importance: 4,
                    content: '常用緩釋手段：\n\n增信措施：\n• 追加抵押/質押物\n• 追加保證人\n• 要求實控人承擔連帶責任\n\n還款安排：\n• 調整還款計劃（前提是有真實還款能力）\n• 部分提前還款減少風險敞口\n• 分期收回本金\n\n監控加強：\n• 提高走訪頻率\n• 要求定期提供財務數據\n• 收緊用款審批',
                    tips: '風險緩釋的核心是「早」。越早行動，選擇越多。等到不良時，談判籌碼就很少了。'
                },
                {
                    id: 'prob-3',
                    title: '不良資產處置途徑',
                    importance: 3,
                    content: '主要處置方式：\n\n自主清收：\n• 協商還款\n• 以物抵債\n• 債務重組\n\n司法途徑：\n• 訴訟追收\n• 申請財產保全\n• 強制執行\n\n轉讓處置：\n• 批量轉讓給資產管理公司\n• 單戶轉讓\n• 資產證券化',
                    tips: '處置方式的選擇取決於：借款人態度、抵押物變現能力、處置成本、時間緊迫性。'
                },
                {
                    id: 'prob-4',
                    title: '案例復盤學習要點',
                    importance: 3,
                    content: '復盤框架：\n\n1. 風險發生的根本原因是什麼？\n2. 在哪個環節可以更早發現？\n3. 貸前審查是否存在漏洞？\n4. 貸後管理是否到位？\n5. 預警信號是否被忽視？\n6. 處置過程有何可改進之處？\n\n記錄並分享經驗教訓，避免同類問題再次發生。',
                    tips: '每一個不良案例都是寶貴的學習素材。不要只看結果，要分析整個過程中哪些節點可以做得更好。'
                },
                {
                    id: 'prob-5',
                    title: '高風險客戶處置案例總匯',
                    importance: 4,
                    content: '真實案例匯總（2024年12月數據）：\n\n案例一：恒大集團（國際）有限公司\n• 風險敞口：32.68億→34.20億（2024年9月至12月）\n• 風險級別：五級\n• 處置策略：持續追蹤訴訟進度、等待債權回收\n• 教訓：集團風險需早期識別，避免集中度過高\n\n案例二：某貿易集團（國際）有限公司\n• 風險敞口：14.06億→14.40億\n• 處置進度：SPV業務1406元正常，周董籌資賣股權抵押展期貸款\n• 監控重點：現金流持續觀察\n\n案例三：周大福企業有限公司\n• 風險敞口：144.17億→157.80億\n• 風險級別：三級\n• 風險成因：SPV業務144.17億正常，其中世界國際（香港）分行已提前HKD4億償還借款\n• 處置策略：SPOTVIEW持續監控\n\n案例四：富豪集團\n• 風險敞口：19.21億→20.29億\n• 風險級別：三級\n• 處置措施：上海團隊接手聯系客戶獲取信息',
                    tips: '真實案例能幫助理解風險傳導鏈條。注意觀察：集團風險如何影響子公司、行業下行如何影響單一客戶。'
                },
                {
                    id: 'prob-6',
                    title: '風險傳導識別：Supply Chain 與 Bond Holder',
                    importance: 4,
                    content: '風險傳導類型識別：\n\n1. Supply Chain 風險（供應鏈傳導）：\n• 核心企業出問題，上下游受牽連\n• Account Receivable 回收困難\n• Foresee 火燒連環船效應\n• 監控重點：前五大客戶/供應商健康度\n\n2. Bond Holder 風險（債券持有人）：\n• 發債企業違約，債券持有人損失\n• 下游交易商被迫拋售\n• 市場流動性枯竭\n• 監控重點：債券發行人信用評級變化\n\n3. 交叉風險識別：\n• 集團客戶多維度敞口\n• 跨境風險傳導（如香港/大陸聯動）\n• 行業系統性風險蔓延',
                    tips: '風險不會單獨存在。識別一個客戶風險時，要同時考慮其上下游、關聯方、行業整體情況。'
                }
            ]
        }
    ],

    // 根據ID獲取知識領域
    getDomainById(id) {
        return this.domains.find(d => d.id === id);
    },

    // 根據ID獲取知識點
    getItemById(itemId) {
        for (const domain of this.domains) {
            const item = domain.items.find(i => i.id === itemId);
            if (item) {
                return { ...item, domain: domain.id, domainName: domain.name };
            }
        }
        return null;
    },

    // 搜索知識點
    search(query) {
        const results = [];
        const lowerQuery = query.toLowerCase();

        for (const domain of this.domains) {
            for (const item of domain.items) {
                if (item.title.toLowerCase().includes(lowerQuery) ||
                    item.content.toLowerCase().includes(lowerQuery)) {
                    results.push({
                        ...item,
                        domain: domain.id,
                        domainName: domain.name
                    });
                }
            }
        }

        return results;
    },

    // 獲取所有知識點總數
    getTotalItemCount() {
        return this.domains.reduce((sum, d) => sum + d.items.length, 0);
    }
};

// 導出供其他模組使用
window.DataManager = DataManager;
window.KnowledgeData = KnowledgeData;
